!function e(t,r,n){function i(o,a){if(!r[o]){if(!t[o]){var u="function"==typeof require&&require;if(!a&&u)return u(o,!0);if(s)return s(o,!0);throw new Error("Cannot find module '"+o+"'")}var l=r[o]={exports:{}};t[o][0].call(l.exports,function(e){var r=t[o][1][e];return i(r?r:e)},l,l.exports,e,t,r,n)}return r[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t){var r="";if("undefined"!=typeof self.document)try{r=document.querySelector('script[src$="local.js"]').src}catch(n){try{r=document.querySelector('script[src$="local.min.js"]').src}catch(n){console.error("Unable to find local.js or local.min.js script tags; unable to setup worker scripts")}}var i='importScripts("'+r+'");\n',s=["local","pageBridge","HEAD","GET","POST","PUT","PATCH","DELETE","SUBSCRIBE","NOTIFY","from","null","self","console","atob","btoa","setTimeout","clearTimeout","setInterval","clearInterval","Proxy","navigator","postMessage","addEventListener","removeEventListener","onmessage","onerror","onclose","dispatchEvent"],o=["XMLHttpRequest","WebSocket","EventSource","FileReaderSync","Worker","importScripts"],a=["(function() {","var nulleds=[];",'var whitelist = ["'+s.join('", "')+'"];',"for (var k in self) {","if (whitelist.indexOf(k) === -1) {","Object.defineProperty(self, k, { value: null, configurable: false, writable: false });","nulleds.push(k);","}","}",'var blacklist = ["'+o.join('", "')+'"];',"blacklist.forEach(function(k) {","Object.defineProperty(self, k, { value: null, configurable: false, writable: false });","nulleds.push(k);","});",'if (typeof console != "undefined") { console.log("Nullified: "+nulleds.join(", ")); }',"})();\n"].join("\n");t.exports={logTraffic:!0,logAllExceptions:!1,maxActiveWorkers:10,virtualOnly:!1,localOnly:!1,workerBootstrapScript:i+a}},{}],2:[function(e,t){t.exports={LINK_NOT_FOUND:1}},{}],3:[function(e,t){function r(e){var r=new t.exports.Request(e);return r.autoEnd(),r}function n(e){return function(n,i){return n instanceof t.exports.Client?n[e]():r({method:e,url:n,params:i})}}var i=e("./util");t.exports={Request:e("./web/request.js"),Response:e("./web/response.js"),IncomingRequest:e("./web/incoming-request.js"),IncomingResponse:e("./web/incoming-response.js"),Bridge:e("./web/bridge.js"),UriTemplate:e("./web/uri-template.js"),util:i,schemes:e("./web/schemes.js"),httpHeaders:e("./web/http-headers.js"),contentTypes:e("./web/content-types.js")},i.mixin.call(t.exports,e("./constants.js")),i.mixin.call(t.exports,e("./config.js")),i.mixin.call(t.exports,e("./promises.js")),i.mixin.call(t.exports,e("./request-event.js")),i.mixin.call(t.exports,e("./web/helpers.js")),i.mixin.call(t.exports,e("./web/links.js")),i.mixin.call(t.exports,e("./web/httpl.js")),i.mixin.call(t.exports,e("./web/workers.js")),i.mixin.call(t.exports,e("./web/subscribe.js")),i.mixin.call(t.exports,e("./web/client.js")),t.exports.dispatch=r,t.exports.HEAD=n("HEAD"),t.exports.GET=n("GET"),t.exports.POST=n("POST"),t.exports.PUT=n("PUT"),t.exports.PATCH=n("PATCH"),t.exports.DELETE=n("DELETE"),t.exports.SUBSCRIBE=n("SUBSCRIBE"),t.exports.NOTIFY=n("NOTIFY");var s,o=t.exports;"undefined"!=typeof window?s=window:"undefined"!=typeof self&&(s=self),s&&(s.local=o,s.HEAD=o.HEAD,s.GET=o.GET,s.POST=o.POST,s.PUT=o.PUT,s.PATCH=o.PATCH,s.DELETE=o.DELETE,s.SUBSCRIBE=o.SUBSCRIBE,s.NOTIFY=o.NOTIFY,s.from=o.client),e("./worker")},{"./config.js":1,"./constants.js":2,"./promises.js":4,"./request-event.js":5,"./util":8,"./web/bridge.js":9,"./web/client.js":10,"./web/content-types.js":11,"./web/helpers.js":12,"./web/http-headers.js":13,"./web/httpl.js":14,"./web/incoming-request.js":15,"./web/incoming-response.js":16,"./web/links.js":17,"./web/request.js":18,"./web/response.js":19,"./web/schemes.js":20,"./web/subscribe.js":21,"./web/uri-template.js":22,"./web/workers.js":23,"./worker":24}],4:[function(e,t){function r(e){return e&&"function"==typeof e.then}function n(e){this.succeedCBs=[],this.failCBs=[],this.__hasValue=!1,this.__hasFailed=!1,this.value=void 0,e&&this.fulfill(e)}function i(e,t,n){if(null===n)e.isRejected()?t.reject(e.value):t.fulfill(e.value);else{var i;try{i=n(e.value)}catch(s){return(c.logAllExceptions||s instanceof Error)&&(console.error?console.error(s,s.stack):console.log("Promise exception thrown",s,s.stack)),t.reject(s)}r(i)?l(i).chain(t):t.fulfill(i)}}function s(e,t){Array.isArray(e)||(e=[e]);var r=l(),n=e.length,i=0;if(0===n)return r.fulfill([]),r;var s=[];s.length=n;for(var o=[],a=function(e,a,u){s[a]=e,u&&o.push(a),++i==n&&(t?t(s,o)?r.fulfill(s):r.reject(s):r.fulfill(s))},u=0;n>u;u++)l(e[u]).succeed(a,u,!1).fail(a,u,!0);return r}function o(e){return s(e,function(e,t){return 0===t.length})}function a(e){return s(e,function(e,t){return t.length<e.length})}function u(e){var t;try{t=e()}catch(n){return(c.logAllExceptions||n instanceof Error)&&(console.error?console.error(n,n.stack):console.log("Promise exception thrown",n,n.stack)),l().reject(n)}return r(t)?t:l(t)}function l(e){if(arguments.length>1)return s(Array.prototype.slice.call(arguments));if(e instanceof n)return e;if(r(e)){var t=l();return e.then(function(e){t.fulfill(e)},function(e){t.reject(e)}),t}return new n(e)}var c=e("./config.js");e("./util"),n.prototype.isUnfulfilled=function(){return!this.__hasValue},n.prototype.isRejected=function(){return this.__hasFailed},n.prototype.isFulfilled=function(){return this.__hasValue&&!this.__hasFailed},n.prototype.then=function(e,t){e=e&&"function"==typeof e?e:null,t=t&&"function"==typeof t?t:null;var r=l();if(this.isUnfulfilled())this.succeedCBs.push({p:r,fn:e}),this.failCBs.push({p:r,fn:t});else{var n=this;n.isFulfilled()?i(n,r,e):i(n,r,t)}return r},n.prototype.succeed=function(e){if(this.isRejected())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(function(r){return e.apply(null,[r].concat(t))})},n.prototype.fail=function(e){if(this.isFulfilled())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(null,function(r){return e.apply(null,[r].concat(t))})},n.prototype.always=function(e){return this.then(e,e)},n.prototype.fulfill=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0;for(var t=0;t<this.succeedCBs.length;t++){var r=this.succeedCBs[t];i(this,r.p,r.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},n.prototype.reject=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0,this.__hasFailed=!0;for(var t=0;t<this.failCBs.length;t++){var r=this.failCBs[t];i(this,r.p,r.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},n.prototype.cancel=function(){var e;for(e=0;e<this.succeedCBs.length;e++)this.succeedCBs[e].p.cancel();for(e=0;e<this.failCBs.length;e++)this.failCBs[e].p.cancel();return this.succeedCBs.length=0,this.failCBs.length=0,this},n.prototype.chain=function(e){return this.then(function(t){return l(e).fulfill(t),t},function(t){return l(e).reject(t),t}),e},n.prototype.cb=function(e,t){e?this.reject(e):this.fulfill("undefined"==typeof t?null:t)},t.exports={Promise:n,promise:l,isPromiselike:r},l.bundle=s,l.all=o,l.any=a,l.lift=u},{"./config.js":1,"./util":8}],5:[function(e,t){function r(e,t){e.__localEventHandlers=[],t=t||{};var r;t.links!==!1&&(r={name:"click",handleEvent:i,container:e},e.addEventListener("click",r,!1),e.__localEventHandlers.push(r)),t.forms!==!1&&(r={name:"click",handleEvent:s,container:e},e.addEventListener("click",r,!0),e.__localEventHandlers.push(r),r={name:"submit",handleEvent:o,container:e},e.addEventListener("submit",r,!1),e.__localEventHandlers.push(r))}function n(e){e.__localEventHandlers&&(e.__localEventHandlers.forEach(function(t){e.removeEventListener(t.name,t)}),delete e.__localEventHandlers)}function i(e){if(0===e.button){var t=a.extractRequest.fromAnchor(e.orgtarget||e.target);if(!t||-1===["_top","_blank"].indexOf(t.target))return t?(e.preventDefault(),e.stopPropagation(),a.dispatchRequestEvent(e.target,t),!1):void 0}}function s(e){0===e.button&&a.trackFormSubmitter(e.target)}function o(e){var t=a.extractRequest(e.target,this.container);if(!t||-1===["_top","_blank"].indexOf(t.target))return t?(e.preventDefault(),e.stopPropagation(),a.finishPayloadFileReads(t).then(function(){a.dispatchRequestEvent(e.target,t)}),!1):void 0}var a=e("./util");t.exports={bindRequestEvents:r,unbindRequestEvents:n}},{"./util":8}],6:[function(e,t){function r(e,t){for(;e;){if(t(e))return e;e=e.parentNode}return null}function n(){for(var e,t=Array.prototype.slice.call(arguments),r={};t.length;)if(e=t.shift())for(var i in e)"undefined"!=typeof e[i]&&null!==e[i]&&(r[i]="object"!=typeof e[i]||Array.isArray(e[i])?e[i]:n(r[i],e[i]));return r}function i(e,t){var r=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:t});e.dispatchEvent(r)}function s(e){var t=r.thatisFormRelated(e);if(t){for(var n=0;n<t.form.length;n++)t.form[n].setAttribute("submitter",null);t.setAttribute("submitter","1")}}function o(e,t){var i={form:{},elem:{}},s=null;if("FORM"===e.tagName)s=e;else{var u=e.getAttribute("form");u&&(s=t.querySelector("#"+u)),s||(s=r.byTag(e,"FORM"))}var l=a(e,s);s&&(i.form=o.fromForm(s,e)),"A"===e.tagName?i.elem=o.fromAnchor(e):-1===["FORM","FIELDSET"].indexOf(e.tagName)&&(i.elem=o.fromFormElement(e));var c=n(i.form,i.elem),f={};return f[/GET/i.test(c.method)?"params":"body"]=l,n(c,f)}function a(e,t,n){n||(n={});var i={};n.nofiles||(i.__fileReads=[]);for(var s=0;s<t.length;s++){var o=t[s];if(o.name&&(!e||r.byElement(o,e))){var a="1"==o.getAttribute("submitter");if("BUTTON"===o.tagName)a&&Object.defineProperty(i,o.name,{configurable:!0,enumerable:!0,writable:!1,value:o.value});else if("INPUT"===o.tagName)switch(o.type.toLowerCase()){case"button":case"submit":a&&Object.defineProperty(i,o.name,{configurable:!0,enumerable:!0,writable:!1,value:o.value});break;case"checkbox":o.checked&&(i[o.name]=(i[o.name]||[]).concat(o.value));break;case"radio":null!==o.getAttribute("checked")&&(i[o.name]=o.value);break;case"file":if(n.nofiles)break;if(o.multiple){for(var l,s=0;l=o.files[s];s++)u(i,o,o.files[s],s);i[o.name]=[],i[o.name].length=s}else u(i,o,o.files[0]);break;default:i[o.name]=o.value}else i[o.name]=o.value}}return i}function u(e,t,r,n){if(r){var i=new FileReader;i.onloadend=l(e,t,r,n),i.readAsDataURL(r)}}function l(t,r,n,i){var s=e("../promises.js").promise();return t.__fileReads.push(s),function(e){var t={content:e.target.result||null,name:n.name,formattr:r.name,size:n.size,type:n.type,lastModifiedDate:n.lastModifiedDate};"undefined"!=typeof i&&(t.formindex=i),s.fulfill(t)}}function c(t){var r=t.body?t.body.__fileReads:t.params?t.params.__fileReads:[];return e("../promises.js").promise.bundle(r).then(function(e){return t.body&&delete t.body.__fileReads,t.params&&delete t.params.__fileReads,e.forEach(function(e){"undefined"!=typeof e.formindex?t.body[e.formattr][e.formindex]=e:t.body[e.formattr]=e}),t})}"undefined"==typeof CustomEvent&&(CustomEvent=function(e,t){var r=document.createEvent("CustomEvent");return r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),r}),r.byTag=function(e,t){return r(e,function(e){return e.tagName==t})},r.byTagOrAlias=function(e,t){return r(e,function(e){return e.tagName==t||e.dataset&&e.dataset.localAlias&&e.dataset.localAlias.toUpperCase()==t})},r.byClass=function(e,t){return r(e,function(e){return e.classList&&e.classList.contains(t)})},r.byElement=function(e,t){return r(e,function(e){return e===t})},r.thatisFormRelated=function(e){return r(e,function(e){return!!e.form})},o.fromAnchor=function(e){if(e=r.byTagOrAlias(e,"A"),!e||!e.attributes.href)return null;var t={method:e.getAttribute("method"),url:e.attributes.href.value,target:e.getAttribute("target"),Accept:e.getAttribute("type")};return t},o.fromFormElement=function(e){var t={method:e.getAttribute("formmethod"),url:e.getAttribute("formaction"),target:e.getAttribute("formtarget"),ContentType:e.getAttribute("formenctype"),Accept:e.getAttribute("formaccept")};return t},o.fromForm=function(e,t){if(t&&!t.form)for(var i=0;i<e.length;i++){var s=e[i];if("1"==s.getAttribute("submitter")){t=s,s.setAttribute("submitter","0");break}}var a={submitter:{},fieldset:{},form:{}};if(t){a.submitter={method:t.getAttribute("formmethod"),url:t.getAttribute("formaction"),target:t.getAttribute("formtarget"),ContentType:t.getAttribute("formenctype"),Accept:t.getAttribute("formaccept")};for(var u=t,l=function(e){return"FIELDSET"==e.tagName||"FORM"==e.tagName};(u=r(u.parentNode,l))&&"FORM"!=u.tagName;)u&&(a.fieldset=n(o.fromFormElement(u),a.fieldset))}a.form={method:e.getAttribute("method"),url:e.getAttribute("action"),target:e.getAttribute("target"),ContentType:e.getAttribute("enctype")||e.enctype,Accept:e.getAttribute("accept")},e.acceptCharset&&(a.form.Accept=e.acceptCharset);var c=n(a.form,a.fieldset,a.submitter);return c},t.exports={findParentNode:r,trackFormSubmitter:s,dispatchRequestEvent:i,extractRequest:o,extractRequestPayload:a,finishPayloadFileReads:c}},{"../promises.js":4}],7:[function(e,t){function r(){Object.defineProperty(this,"_events",{value:{},configurable:!1,enumerable:!1,writable:!0}),Object.defineProperty(this,"_memo",{value:null,configurable:!1,enumerable:!1,writable:!0})}t.exports=r,r.prototype.memoEventsTillNextTick=function(){this._memo||(this._memo=[],e("./index.js").nextTick(function(){this._memo=null}.bind(this)))},r.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments);t=t.slice(1);var r=this._events[e];if(r)for(var n=0,i=r.length;i>n;n++)r[n].apply(this,t);return this._memo&&this._memo.push([e,t]),!0},r.prototype.addListener=function(e,t){if(Array.isArray(e))return e.forEach(function(e){this.addListener(e,t)},this),void 0;if("function"!=typeof t)throw new Error("addListener only takes instances of Function");if(this.emit("newListener",e,t),this._events[e]?this._events[e].push(t):this._events[e]=[t],this._memo&&this._memo.length)for(var r=0;r<this._memo.length;r++)this._memo[r][0]==e&&t.apply(this,this._memo[r][1]);return this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){var r=this;return r.on(e,function n(){r.removeListener(e,n),t.apply(this,arguments)}),this},r.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var r=this._events[e],n=r.indexOf(t);return 0>n?this:(r.splice(n,1),0===r.length&&delete this._events[e],this)},r.prototype.removeAllListeners=function(e){return e?this._events[e]=null:this._events={},this},r.prototype.clearEvents=function(){for(var e in this._events)this.removeAllListeners(e);return this},r.prototype.listeners=function(e){return this._events[e]}},{"./index.js":8}],8:[function(e,t){function r(e){for(var t in e)this[t]=e[t]}function n(e){a.call(e),r.call(e,a.prototype)}function i(e){return JSON.parse(JSON.stringify(e))}function s(e){var t,r,n=-1,i=[];for(r=1,n;r<arguments.length;r++,n++)e[n]||(t&&i.push(t),t={},n=0),"undefined"!=typeof arguments[r]&&(t[e[n]]=arguments[r]);return i.push(t),i}var o,a=e("./event-emitter.js"),u=e("./dom.js");if("undefined"==typeof window||window.ActiveXObject||!window.postMessage)o=function(e){setTimeout(e,0)};else{var l=0,c=[];o=function(e){c.length||window.postMessage("nextTick","*"),c.push(e)},window.addEventListener("message",function(e){if("nextTick"==e.data){for(;l<c.length;){var t=l;l++,c[t]()}c.length=0,l=0}},!0)}t.exports={EventEmitter:a,mixin:r,mixinEventEmitter:n,deepClone:i,table:s,nextTick:o},r.call(t.exports,u)},{"./dom.js":6,"./event-emitter.js":7}],9:[function(e,t){function r(e){this.channel=e,this.sidCounter=1,this.incomingStreams={},this.outgoingStreams={},this.msgBuffer=[]}function n(e){return""===e?!1:(e=e.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,""),/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/.test(e))}function i(e){return e?isNaN(e.sid)?!1:!0:!1}var s=e("./helpers.js");e("./request.js");var o=e("./response.js"),a=e("./incoming-request.js"),u=e("./incoming-response.js"),l=!1;t.exports=r,r.prototype.log=function(e){var t=Array.prototype.slice.call(arguments,1);console[e].apply(console,t)},r.prototype.flushBufferedMessages=function(){l&&this.log("debug","FLUSHING MESSAGES",JSON.stringify(this.msgBuffer)),this.msgBuffer.forEach(function(e){this.channel.postMessage(e)},this),this.msgBuffer.length=0},r.prototype.send=function(e){this.channel.isReady===!1?this.msgBuffer.push(e):(l&&this.log("debug","SEND",e),this.channel.postMessage(e))},r.prototype.terminate=function(e,t){e=e||503,t=t||"Service Unavailable";for(var r in this.incomingStreams){var n=this.incomingStreams[r];n instanceof o&&!n.headers.status&&n.status(e,t),n.end?n.end():n.clearEvents()}for(r in this.outgoingStreams){var n=this.outgoingStreams[r];n instanceof o&&!n.headers.status&&n.status(e,t),n.end?n.end():n.clearEvents()}this.incomingStreams={},this.outgoingStreams={},this.msgBuffer.length=0,this.channel=null},r.prototype.onRequest=function(e,t){var r=this.sidCounter++;this.outgoingStreams[r]=e,this.incomingStreams[-r]=t;var n={sid:r,method:e.method,path:e.path,params:e.params};for(var i in e)s.isHeaderKey(i)&&(n[i]=e[i]);this.send(n);var o=this;e.on("data",function(e){o.send({sid:r,body:e})}),e.on("end",function(){o.send({sid:r,end:!0})}),e.on("close",function(){o.send({sid:r,close:!0}),delete o.outgoingStreams[r]})},r.prototype.onMessage=function(t){if(l&&this.log("debug","RECV",t),"string"==typeof t){if(!n(t))return this.log("warn","Dropping malformed JSON message",t),void 0;t=JSON.parse(t)}if(!i(t))return this.log("warn","Dropping malformed HTTPL message",t),void 0;var r=this.incomingStreams[t.sid];if(!r){if(t.sid<0)return this.log("warn","Dropping unexpected HTTPL response message",t),void 0;if(!t.path)return this.log("warn","Dropping HTTPL request with no path",t);for(var c,f,p=e("./httpl.js"),h=p.getRoutes(),d=0;d<h.length;d++)if(f=h[d].path.exec(t.path)){c=h[d].handler;break}t.pathd=f,c||(c=function(e,t){t.s404("not found").end()});var m=new a(t),y=new u,v=new o;r=this.incomingStreams[t.sid]=m,this.outgoingStreams[b]=y,v.wireUp(y),m.memoEventsTillNextTick(),y.memoEventsTillNextTick();var g=this,b=-t.sid;y.on("headers",function(e){var t={sid:b,status:e.status,reason:e.reason};for(var r in e)s.isHeaderKey(r)&&(t[r]=e[r]);y.processHeaders(g.channel.source_url,e),g.send(t)}),y.on("data",function(e){g.send({sid:b,body:e})}),y.on("end",function(){g.send({sid:b,end:!0})}),y.on("close",function(){g.send({sid:b,close:!0}),delete g.outgoingStreams[b]}),c(m,v,this.channel)}if(t.sid<0&&r instanceof o){if("undefined"!=typeof t.status){r.status(t.status,t.reason);for(var w in t)s.isHeaderKey(w)&&r.header(w,t[w]);r.start()}t.body&&r.write(t.body),t.end&&r.end(),t.close&&(r.close(),delete this.incomingStreams[t.sid])}else t.sid>0&&r instanceof a&&(t.body&&r.emit("data",t.body),t.end&&r.emit("end"),t.close&&(r.emit("close"),delete this.incomingStreams[t.sid]))},r.prototype.isInTransaction=function(){if(0!==Object.keys(this.incomingStreams).length)for(var e in this.incomingStreams)if(this.incomingStreams[e]instanceof o&&this.incomingStreams[e].isConnOpen)return!0;return!1}},{"./helpers.js":12,"./httpl.js":14,"./incoming-request.js":15,"./incoming-response.js":16,"./request.js":18,"./response.js":19}],10:[function(e,t){function r(e){this.query=e,this.resolveState=r.UNRESOLVED,this.error=null,this.queryIsAbsolute="string"==typeof e,this.queryIsAbsolute?(this.url=e,this.urld=u.parseUri(this.url)):(this.url=null,this.urld=null)}function n(e,t){this.context=e||null,this.parentClient=t||null,this.links=null}function i(e){return function(t){return this.dispatch({method:e,params:t})}}function s(e){return function(t,r){return t&&"object"==typeof t&&(r=t),r=r||{},r.rel=r.rel?e+" "+r.rel:e,t&&(r.id=t),this.follow(r)}}var o=e("../constants.js");e("../util");var a=e("../promises.js").promise,u=e("./helpers.js"),l=e("./uri-template.js");e("./httpl.js");var c=e("./request.js"),f=e("./response.js"),p=e("./subscribe.js").subscribe;r.UNRESOLVED=0,r.RESOLVED=1,r.FAILED=2,r.prototype.isResolved=function(){return this.resolveState===r.RESOLVED},r.prototype.isBad=function(){return this.resolveState===r.FAILED},r.prototype.isRelative=function(){return!this.queryIsAbsolute},r.prototype.isAbsolute=function(){return this.queryIsAbsolute},r.prototype.getUrl=function(){return this.url},r.prototype.getError=function(){return this.error},r.prototype.resetResolvedState=function(){this.resolveState=r.UNRESOLVED,this.error=null},r.prototype.setResolved=function(e){this.error=null,this.resolveState=r.RESOLVED,e&&(this.url=e,this.urld=u.parseUri(this.url))},r.prototype.setFailed=function(e){this.error=e,this.resolveState=r.FAILED},n.prototype.dispatch=function(e){e||(e={});var t=this,r=void 0!==e.isAutoEnding?e.isAutoEnding:!0;return e instanceof c||(e=new c(e)),e.autoEnd(!1),(e.url?a(e.url):this.resolve({noretry:e.noretry,nohead:!0})).succeed(function(n){return e.headers.url=n,r&&e.autoEnd(),e.start(),e.succeed(function(e){return t.context.setResolved(),t.links=e.links?e.links:t.links||[],e}),e.fail(function(e){throw(e.status===o.LINK_NOT_FOUND||404===e.status)&&t.context.setFailed(e),e}),e}).fail(function(t){e.reject(t)}),e},n.prototype.subscribe=function(e){var t;return e||(e={}),this.resolve({nohead:!0}).succeed(function(r){return e.url=r,t=p(e)})},n.prototype.follow=function(e){"string"==typeof e&&(e=u.isNavSchemeUri(e)?u.parseNavUri(e):{rel:e}),Array.isArray(e)||(e=[e]);var t=this;do t=new n(new r(e.shift()),t),this.requestDefaults&&t.setRequestDefaults(this.requestDefaults);while(e[0]);return t},n.prototype.unresolve=function(){return this.context.resetResolvedState(),this.links=null,this},n.prototype.rebase=function(e){return this.unresolve(),this.context.query=e,this.context.queryIsAbsolute=!0,this.context.url=e,this.context.urld=u.parseUri(e),this},n.prototype.resolve=function(e){var t=this;e=e||{};var r=e.nohead;delete e.nohead;var n=a();return null!==this.links&&(this.context.isResolved()||this.context.isAbsolute()&&this.context.isBad()===!1)?n.fulfill(this.context.getUrl()):this.context.isBad()===!1||this.context.isBad()&&!e.noretry?(this.context.resetResolvedState(),this.context.isRelative()&&this.parentClient?n=this.parentClient.resolve(e).succeed(function(){var e=t.parentClient.lookupLink(t.context);if(e)return t.context.setResolved(e),r?e:t.dispatch({method:"HEAD",url:e}).succeed(function(){return e});var n=new f;throw n.status(o.LINK_NOT_FOUND,"Link Query Failed to Match").end(),n}).fail(function(e){throw t.context.setFailed(e),e}):r?n.fulfill(t.context.getUrl()):n=t.dispatch({method:"HEAD",url:t.context.getUrl()}).succeed(function(){return t.context.getUrl()})):n.reject(this.context.getError()),n},n.prototype.lookupLink=function(e){if(e.query)if("object"==typeof e.query){var t=u.queryLinks(this.links,e.query)[0];if(t)return l.parse(t.href).expand(e.query)}else if("string"==typeof e.query)return u.isAbsUri(e.query)?e.query:u.joinRelPath(this.context.urld,e.query);return console.log("Failed to find a link to resolve context. Link query:",e.query,"Client:",this),null},n.prototype.HEAD=i("HEAD"),n.prototype.GET=i("GET"),n.prototype.DELETE=i("DELETE"),n.prototype.POST=i("POST"),n.prototype.PUT=i("PUT"),n.prototype.PATCH=i("PATCH"),n.prototype.SUBSCRIBE=i("SUBSCRIBE"),n.prototype.NOTIFY=i("NOTIFY"),["service","collection","item","via","up","first","prev","next","last","self"].forEach(function(e){n.prototype[e]=s(e)});var h=function(e){if(e instanceof n)return e;"string"==typeof e&&u.isNavSchemeUri(e)&&(e=u.parseNavUri(e)),Array.isArray(e)||(e=[e]);for(var t=new n(new r(e.shift()));e[0];)t=new n(new r(e.shift()),t);return t};t.exports={Client:n,client:h}},{"../constants.js":2,"../promises.js":4,"../util":8,"./helpers.js":12,"./httpl.js":14,"./request.js":18,"./response.js":19,"./subscribe.js":21,"./uri-template.js":22}],11:[function(e,t){function r(e){switch(e){case"plain":case"plaintext":case"text":return"text/plain";case"html":return"text/html";case"csv":return"text/csv";case"events":case"event-stream":return"text/event-stream";case"json":return"application/json";case"xml":return"application/xml";case"javascript":case"js":return"application/javascript";case"form":case"urlencoded":return"application/x-www-form-urlencoded"}return e}function n(e,t){if(!t||"object"!=typeof t||!e)return t;var r=a(e,"serializer");return r?r(t):t}function i(e,t){if(!t||"string"!=typeof t||!e)return t;var r=a(e,"deserializer");if(!r)return t;try{return r(t)}catch(n){return console.warn("Failed to deserialize content",e,t),t}}function s(e,t,r){c[e]={serializer:t,deserializer:r}}function o(e){var t=e.split(";"),r=t[0];if(t=r.split("/"),t[1]){var n=t[1].split("+");return n[1]?[r,t[0]+"/"+n[1],t[0]]:[r,t[0]]}return[r]}function a(e,t){e=r(e);for(var n=o(e),i=0;i<n.length;i++)if(n[i]in c)return c[n[i]][t];return null}function u(e){var t=e.indexOf(":");return[e.slice(0,t).trim(),e.slice(t+1).trim()]}var l={serialize:n,deserialize:i,register:s,lookup:r},c={};t.exports=l,l.register("application/json",function(e){try{return JSON.stringify(e)}catch(t){return t.message}},function(e){try{return JSON.parse(e)}catch(t){return t.message}}),l.register("application/x-www-form-urlencoded",function(e){var t=encodeURIComponent,r=[];for(var n in e)if(null===e[n])r.push(n+"=");else if(Array.isArray(e[n]))for(var i=0;i<e[n].length;i++)r.push(n+"[]="+t(e[n][i]));else if("object"==typeof e[n])for(var s in e[n])r.push(n+"["+s+"]="+t(e[n][s]));else r.push(n+"="+t(e[n]));return r.join("&")},function(e){for(var t=e.split("&"),r={},n=0;n<t.length;n++){var i=t[n].split("="),s=decodeURIComponent(i[0]),o=decodeURIComponent(i[1]),a=/\[\]$/.test(s),u=s.match(/^(.+)\[([^\]]+)\]$/);if("true"===o?o=!0:"false"===o?o=!1:+o==o&&(o=+o),u){s=u[1];var l=u[2];r[s]=r[s]||{},r[s][l]=o}else a?(s=s.substring(0,s.length-2),r[s]=r[s]||[],r[s].push(o)):r[s]=o}return r}),l.register("text/event-stream",function(e){var t="";return"undefined"!=typeof e.event&&(t+="event: "+e.event+"\r\n"),"undefined"!=typeof e.data&&(t+="data: "+JSON.stringify(e.data)+"\r\n"),t+"\r\n"},function(e){var t={};if(e.split("\r\n").forEach(function(e){/^[\s]*$/.test(e)||(e=u(e),e[0]&&(t[e[0]]=e[1]))}),t.data)try{t.data=JSON.parse(t.data)}catch(r){}return t})},{}],12:[function(e,t){function r(e,t){t||(t={}),"undefined"==typeof t.links&&(t.links=!0);var r=[];return t.links&&(r=r.concat(Array.prototype.slice.call(e.querySelectorAll("link")))),t.anchors&&(r=r.concat(Array.prototype.slice.call(e.querySelectorAll("a")))),r.map(function(e){for(var t={},r=0;r<e.attributes.length;r++)t[e.attributes[r].name]=e.attributes[r].value;return t})}function n(e,t){return e?(T&&e instanceof Document&&(e=r(e)),e.parsedHeaders&&(e=e.parsedHeaders.link),"string"==typeof t&&(t={rel:t}),Array.isArray(e)?e.filter(function(e){return i(e,t)}):[]):[]}function i(e,t){"string"==typeof t&&(t={rel:t});for(var r in t)if("function"==typeof t[r]){if(!t[r].call(null,e[r],r))return!1}else if(t[r]instanceof RegExp){if(!t[r].test(e[r]))return!1}else if("rel"==r)for(var n=t.rel.split(/\s+/),i=0;i<n.length;i++){var s=!0;if("!"==n[i].charAt(0)&&(n[i]=n[i].slice(1),s=!1),RegExp("(\\s|^)(.*//)?"+n[i]+"(\\s|$)","i").test(e.rel)!==s)return!1}else if("undefined"==typeof e[r]){if(RegExp(k+r+C,"i").test(e.href)===!0)continue;if(t[r])return!1}else if(t[r]&&t[r].indexOf&&0===t[r].indexOf("!")){if(e[r]==t[r].slice(1))return!1}else if(e[r]!=t[r])return!1;return!0}function s(e,t){return e&&t?(T&&e instanceof Document&&(e=r(e)),e.parsedHeaders&&(e=e.parsedHeaders.link),Array.isArray(e)?(Array.isArray(t)||(t=t.split(" ")),e.filter(function(e){return o(e,t)})):[]):[]}function o(e,t){var r="";if("string"==typeof e)r=e;else for(var n in e)r+=e[n]+" ";Array.isArray(t)||(t=t.split(" "));for(var i=0;i<t.length;i++)if(-1===r.indexOf(t[i]))return!1;return!0}function a(e,t){var r=t.filter(function(t){return l(e,t)}).sort(function(e,t){return e.q>t.q?-1:1});return r[0]?r[0].q:0}function u(e,t){return"*"===e||e===t}function l(e,t){var r=c(e);if(t.params){var n=Object.keys(t.params);if(n.some(function(e){return!u(t.params[e],r.params[e])}))return null}return u(t.type,r.type)&&u(t.subtype,r.subtype)?t:void 0}function c(e){var t=e.match(/\s*(\S+)\/([^;\s]+)\s*(?:;(.*))?/);if(!t)return null;var r=t[1],n=t[2],i=""+r+"/"+n,s={},o=1;return t[3]&&(s=t[3].split(";").map(function(e){return e.trim().split("=")}).reduce(function(e,t){return e[t[0]]=t[1],e},s),null!==s.q&&(o=parseFloat(s.q),delete s.q)),{type:r,subtype:n,params:s,q:o,full:i}}function f(e){return e.split(",").map(function(e){return c(e.trim())}).filter(function(e){return e&&e.q>0})}function p(e,t){return"object"==typeof e&&(e=e.headers.accept),e=f(e||""),t?(Array.isArray(t)||(t=[t]),t.map(function(t){return t=E.lookup(t),[t,a(t,e)]}).filter(function(e){return e[1]>0}).sort(function(e,t){return e[1]===t[1]?0:e[1]>t[1]?-1:1}).map(function(e){return e[0]})):e.map(function(e){return e.full})}function h(e,t){return p(e,t)[0]}function d(){var e=Array.prototype.map.call(arguments,function(e,t){e=""+e;var r=e.length;return"/"==e||"#"==e?e:("/"===e.charAt(r-1)&&(r-=1),e=e.substring(0,r),0!==t&&"/"!=e.charAt(0)&&"#"!=e.charAt(0)?"/"+e:e)});return e.join("")}function m(e){return S.test(e)}function y(e){return O.test(e)}function v(e,t){"string"==typeof e&&(e=g(e));var r=e.protocol?e.protocol+"://":"";if(r||(0===e.source.indexOf("//")?r="//":0===e.source.indexOf("||")?r="||":e.authority&&(r="http://")),"/"==t.charAt(0))return r+e.authority+t;if("#"==t.charAt(0))return r+e.authority+e.path+t;for(var n=e.path,i=n.split("/"),s=t.split("/"),o=0,a=s.length;a>o;o++)"."!=s[o]&&(".."==s[o]?i.pop():i.push(s[o]));var u=i.join("/");return d(r+e.authority,u)}function g(e){if("object"==typeof e&&(e.url?e=e.url:(e.headers&&e.headers.host||e.path)&&(e=d(e.headers.host,e.path))),"data:"==e.slice(0,5))return{protocol:"data",source:e};for(var t=g.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},i=15;i--;)n[t.key[i]]=r[i]||"";return n[t.q.name]={},n[t.key[13]].replace(t.q.parser,function(e,r,i){r&&(n[t.q.name][r]=i)}),n}function b(e){if(!e)return[];var t=e.indexOf("||");-1!==t&&(e=e.slice(t+2));for(var r=e.split("|"),n=1;n<r.length;n++){for(var i={},s=r[n].split(","),o=0;o<s.length;o++){var a=s[o].split("=");0===o?(i.rel=a[0].replace(/\+/g," "),a[1]&&(i.id=a[1])):i[a[0]]=decodeURIComponent(a[1]).replace(/\+/g," ")}r[n]=i}return r.length>6&&(r.length=6),r[0]||r.shift(),r}function w(e,t){Array.isArray(t)||(t=[t]);for(var r=t.length-1;r>=0;r--){var n=t[r];e=A.parse(n).expand({uri:e})}return e}function j(e,t){return A.parse(e).expand(t)}function x(e){return q.test(e)}e("../promises.js").promise;var E=e("./content-types.js"),A=e("./uri-template.js"),T="undefined"!=typeof Document,k="\\{([^\\}]*)[\\+\\#\\.\\/\\;\\?\\&]?",C="(\\,|\\})",S=/^((http(s|l)?:)?\/\/)|((nav:)?\|\|)|(data:)/,O=/^(nav:)?\|?\|/i;g.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","srcPath","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@\/]*)(?::([^:@\/]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@\/]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@\/]*)(?::([^:@\/]*))?)?@)?([^:\/\(?#]*)(?::(\d*))?(?:\(([^\)]+)\))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var q=/^[A-Z]/;t.exports={extractDocumentLinks:r,queryLinks:n,queryLink:i,searchLinks:s,searchLink:o,preferredTypes:p,preferredType:h,parseMediaType:c,parseAcceptHeader:f,joinUri:d,joinUrl:d,joinRelPath:v,isAbsUri:m,isAbsUrl:m,isNavSchemeUri:y,isNavSchemeUrl:y,isHeaderKey:x,parseUri:g,parseUrl:g,parseNavUri:b,parseNavUrl:b,makeProxyUri:w,makeProxyUrl:w,renderUri:j,renderUrl:j}},{"../promises.js":4,"./content-types.js":11,"./uri-template.js":22}],13:[function(e,t){function r(e,t){if(!t||"object"!=typeof t||!e)return t;var r=s(e,"serializer");if(!r)return t;try{return r(t)}catch(n){return console.warn("Failed to serialize header",e,t),t}}function n(e,t){if(!t||"string"!=typeof t||!e)return t;
var r=s(e,"deserializer");if(!r)return t;try{return r(t)}catch(n){return console.warn("Failed to deserialize header",e,t),t}}function i(e,t,r){u[e.toLowerCase()]={serializer:t,deserializer:r}}function s(e,t){var r=u[e.toLowerCase()];return r?r[t]:null}var o=e("./helpers.js"),a={serialize:r,deserialize:n,register:i},u={};t.exports=a;var l=/<(.*?)>(?:;[\s]*(.*?)((,(?=[\s]*<))|$))/g,c=/([\-a-z0-9_\.]+)=?(?:(?:"([^"]+)")|([^;\s]+))?/g;a.register("link",function(e){var t=[];return e.forEach(function(e){var r=["<"+e.href+">"];for(var n in e)"href"!=n&&null!==e[n]&&("boolean"==typeof e[n]&&e[n]?r.push(n):r.push(n+'="'+e[n]+'"'));t.push(r.join("; "))}),t.join(", ")},function(e){for(var t,r,n,i=[];t=l.exec(e);){for(n={href:t[1]};r=c.exec(t[2]);)n[r[1]]=r[2]||r[3]||!0;i.push(n)}return i}),a.register("accept",function(e){return e.map(function(e){var t=[e.full];1!==e.q&&t.push("q="+e.q);for(var r in e.params)t.push(r+"="+e.params[r]);return t.join("; ")}).join(", ")},o.parseAcceptHeader)},{"./helpers.js":12}],14:[function(e,t){function r(e,t){"#"!=e.charAt(0)&&(e="#"+e),e=new RegExp("^"+e+"$","i"),u.push({path:e,handler:t})}function n(){return u}e("./helpers.js");var i=e("./schemes.js");e("./content-types.js");var s=e("./incoming-request.js"),o=e("./response.js"),a=e("./workers.js"),u=[];i.register("#",function(e,t){var r=local.parseUri("/"+(e.urld.anchor||""));if(r.query){var n=local.contentTypes.deserialize("application/x-www-form-urlencoded",r.query);e.param(n)}e.headers.path="#"+r.path.slice(1);var i,l=function(){for(var t,r=0;r<u.length;r++)if(t=u[r].path.exec(e.headers.path))return e.headers.pathd=t,u[r].handler},c="undefined"==typeof self.document;i=e.urld.authority||e.urld.path?"page"==e.urld.authority?c?self.pageBridge.onRequest.bind(self.pageBridge):l():a.getWorker(e.urld):l();var f=new s(e.headers),p=new o;e.wireUp(f),p.wireUp(t),f.memoEventsTillNextTick(),t.memoEventsTillNextTick(),e.on("close",function(){p.close()}),e.isBinary&&console.warn("Got virtual request with binary=true - sorry, not currently supported",e),i?i(f,p,e.originChannel):p.s404().end()}),t.exports={at:r,getRoutes:n}},{"./content-types.js":11,"./helpers.js":12,"./incoming-request.js":15,"./response.js":19,"./schemes.js":20,"./workers.js":23}],15:[function(e,t){function r(e){n.EventEmitter.call(this);var t=this,r=function(e,r){Object.defineProperty(t,e,{value:r,writable:!0})};this.method=e.method?e.method.toUpperCase():"GET",this[this.method]=!0,this.path=e.path||"#",this.pathd=e.pathd||[this.path],this.params=e.params||{};for(var o in e)if(i.isHeaderKey(o)){this[o]=e[o];var a=s.deserialize(o,e[o]);a&&"string"!=typeof a&&(this[o.toLowerCase()]=a)}r("isConnOpen",!0),r("isStarted",!0),r("isEnded",!1),this.on("end",function(){t.isEnded=!0})}var n=e("../util"),i=e("./helpers.js"),s=e("./http-headers.js"),o=e("./content-types.js");r.prototype=Object.create(n.EventEmitter.prototype),t.exports=r,r.prototype.buffer=function(e){if("undefined"==typeof this._buffer){var t=this;this._buffer="",this.body=null,this.on("data",function(e){"string"==typeof e?t._buffer+=e:t._buffer=e}),this.on("end",function(){t.body=t.ContentType?o.deserialize(t.ContentType,t._buffer):t._buffer})}this.on("end",e)},r.prototype.pipe=function(t,r,n){if(r=r||function(e,t){return t},n=n||function(e){return e},t.autoEnd&&t.autoEnd(!1),t instanceof e("./request")){t.headers.method||(t.headers.method=this.method),t.headers.url||(t.headers.url=this.url);for(var s in this)i.isHeaderKey(s)&&t.header(s,r(s,this[s]))}else t instanceof e("./response")&&!t.headers.ContentType&&this.ContentType&&t.ContentType(this.ContentType);return this.isEnded?t.end(n(this.body)):(this.on("data",function(e){t.write(n(e))}),this.on("end",function(){t.end()})),t}},{"../util":8,"./content-types.js":11,"./helpers.js":12,"./http-headers.js":13,"./request":18,"./response":19}],16:[function(e,t){function r(){n.EventEmitter.call(this);var e=this,t=function(t,r){Object.defineProperty(e,t,{value:r,writable:!0})};this.status=0,this.reason=void 0,t("latency",void 0),t("isConnOpen",!0),t("isStarted",!0),t("isEnded",!1),this.on("end",function(){e.isEnded=!0})}var n=e("../util"),i=e("./helpers.js"),s=e("./http-headers.js"),o=e("./content-types.js");r.prototype=Object.create(n.EventEmitter.prototype),t.exports=r,r.prototype.processHeaders=function(t,r){this.status=r.status,this.reason=r.reason;for(var n in r)if(i.isHeaderKey(n)){this[n]=r[n];var o=s.deserialize(n,r[n]);o&&"string"!=typeof o&&(this[n.toLowerCase()]=o)}this.links=e("./links").processLinks(this.link||[],t),delete this.link},r.prototype.buffer=function(e){if("undefined"==typeof this._buffer){var t=this;this._buffer="",this.body=null,this.on("data",function(e){"string"==typeof e?t._buffer+=e:t._buffer=e}),this.on("end",function(){t.body=t.ContentType?o.deserialize(t.ContentType,t._buffer):t._buffer})}this.on("end",e)},r.prototype.pipe=function(t,r,n){if(r=r||function(e,t){return t},n=n||function(e){return e},t.autoEnd&&t.autoEnd(!1),t instanceof e("./response")){t.headers.status||t.status(this.status,this.reason);for(var s in this)i.isHeaderKey(s)&&t.header(s,r(s,this[s]))}else if(t instanceof e("./request")){if(this.status<200||this.status>=400)return t.close(),t;!t.headers.ContentType&&this.ContentType&&t.ContentType(this.ContentType)}return this.isEnded?t.end(n(this.body)):(this.on("data",function(e){t.write(n(e))}),this.on("end",function(){t.end()})),t}},{"../util":8,"./content-types.js":11,"./helpers.js":12,"./http-headers.js":13,"./links":17,"./request":18,"./response":19}],17:[function(e,t){var r=e("./helpers");t.exports.processLinks=function(e,t){return e||(e=[]),e=Array.isArray(e)?e:[e],e.forEach(function(e){e.href&&!r.isAbsUri(e.href)&&t&&("#"==e.href.charAt(0)?(t.source&&(t=(t.protocol?t.protocol+"://":"")+t.authority+t.path),e.href=r.joinUri(t,e.href)):e.href=r.joinRelPath(t,e.href)),e.is&&"function"!=typeof e.is&&(e._is=e.is),n.value=r.queryLink.bind(null,e),Object.defineProperty(e,"is",n)}),n.value=r.queryLinks.bind(null,e),Object.defineProperty(e,"query",n),n.value=function(e){return this.query(e)[0]},Object.defineProperty(e,"get",n),n.value=r.searchLinks.bind(null,e),Object.defineProperty(e,"search",n),e};var n={value:null,enumerable:!1,configurable:!0,writable:!0}},{"./helpers":12}],18:[function(e,t){function r(e,t){o.EventEmitter.call(this),a.Promise.call(this),e||(e={}),"string"==typeof e&&(e={url:e}),this.headers=e,this.headers.method=this.headers.method?this.headers.method.toUpperCase():"GET",this.headers.params=this.headers.params||{},this.originChannel=t,this.isBinary=!1,this.isVirtual=local.virtualOnly||void 0,this.isForcedLocal=local.localOnly,this.isBufferingResponse=!0,this.isAutoEnding=!1,this.isConnOpen=!0,this.isStarted=!1,this.isEnded=!1}function n(e){return e.replace(h,function(e,t,r){return r.toUpperCase()})}function i(e,t){e.isUnfulfilled()&&(local.logTraffic&&console.log(e.headers,t),t.status>=200&&t.status<400?e.fulfill(t):t.status>=400&&t.status<600||0===t.status?e.reject(t):e.fulfill(t))}function s(e){var t=/^([^.^:]*):/.exec(e);return t?t[1]:"http"}var o=e("../util"),a=e("../promises.js"),u=e("./helpers.js"),l=e("./schemes.js"),c=e("./content-types.js"),f=e("./response.js"),p=e("./incoming-response.js");r.prototype=Object.create(o.EventEmitter.prototype),o.mixin.call(r.prototype,a.Promise.prototype),r.fulfillResponsePromise=i,t.exports=r,r.prototype.header=function(e,t){return e=n(e),("Accept"==e||"ContentType"==e)&&(t=c.lookup(t)),this.headers[e]=t,this},["Accept","Authorization","ContentType","Expect","From","Pragma"].forEach(function(e){r.prototype[e]=function(t){return this.header(e,t)}});var h=/(^|-)(.)/g;["json","text","html","csv"].forEach(function(e){r.prototype[e]=function(t){return this.ContentType(e),this.write(t),this},r.prototype["to"+e]=function(){return this.Accept(e),this}}),r.prototype.param=function(e,t){if(e&&"object"==typeof e)for(var r in e)this.param(r,e[r]);else this.headers.params[e]=t;return this},r.prototype.setTimeout=function(e){var t=this;if(!this.__timeoutId)return this.__timeoutId=setTimeout(function(){t.isConnOpen&&t.close(),delete t.__timeoutId},e),this},r.prototype.setBinary=function(e){return this.isBinary="boolean"==typeof e?e:!0,this},r.prototype.setVirtual=function(e){return this.isVirtual=void 0!==e?e:!0,this},r.prototype.forceLocal=function(e){return this.isForcedLocal="boolean"==typeof e?e:!0,this},r.prototype.bufferResponse=function(e){return this.isBufferingResponse="boolean"==typeof e?e:!0,this},r.prototype.autoEnd=function(e){if(e="undefined"!=typeof e?e:!0,e&&!this.isAutoEnding){var t=this;o.nextTick(function(){t.isAutoEnding&&t.end()})}this.isAutoEnding=e},r.prototype.pipe=function(e,t,r){return e.autoEnd&&e.autoEnd(!1),this.always(function(n){n.pipe(e,t,r)}),e},r.prototype.wireUp=function(e,t){if(t){var r=function(e){return function(t){o.nextTick(e.bind(null,t))}};this.once("headers",r(e.emit.bind(e,"headers"))),this.on("data",r(e.emit.bind(e,"data"))),this.once("end",r(e.emit.bind(e,"end")))}else this.once("headers",e.emit.bind(e,"headers")),this.on("data",e.emit.bind(e,"data")),this.once("end",e.emit.bind(e,"end"))},r.prototype.start=function(){var e=this;if(!this.isConnOpen)return this;if(this.isStarted)return this;if(!this.headers||!this.headers.url)throw"No URL on request";if("undefined"==typeof this.isVirtual&&(this.isVirtual=-1!==this.headers.url.indexOf("#")),this.isForcedLocal&&"#"!==this.headers.url.charAt(0)&&(this.headers.url="#"+this.headers.url,this.isVirtual=!0),"/"==this.headers.url.charAt(0)&&"undefined"!=typeof window.location){var t=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"");this.headers.url=u.joinUri(t,this.headers.url)}this.urld=u.parseUri(this.headers.url);var r=Date.now(),n=new p;n.on("headers",n.processHeaders.bind(n,!this.isVirtual||this.urld.authority||this.urld.path?this.urld:!1)),n.on("end",function(){n.latency=Date.now()-r}),n.on("close",function(){e.close()});var o=i.bind(null,this,n);this.isBufferingResponse?n.buffer(o):n.on("headers",o),n.on("close",o);var a=this.isVirtual?"#":s(this.headers.url),c=l.get(a);if(c)c(this,n);else{var h=new f;h.wireUp(n),h.status(0,'unsupported scheme "'+a+'"').end()}return this.isStarted=!0,this},r.prototype.write=function(e){return this.isConnOpen?(this.isStarted||this.start(),this.isEnded?this:(this.emit("data",e),this)):this},r.prototype.end=function(e){return this.isConnOpen?this.isEnded?this:(this.isStarted||this.start(),"undefined"!=typeof e&&this.write(e),this.isEnded=!0,this.emit("end"),this):this},r.prototype.close=function(){if(!this.isConnOpen)return this;if(this.isConnOpen=!1,this.emit("close"),this.clearEvents(),!this.isStarted){var e=new p;e.on("headers",e.processHeaders.bind(e,!this.isVirtual||this.urld.authority||this.urld.path?this.urld:!1));var t=new f;t.wireUp(e),t.status(0,"aborted by client").end(),i(this,e)}return this}},{"../promises.js":4,"../util":8,"./content-types.js":11,"./helpers.js":12,"./incoming-response.js":16,"./response.js":19,"./schemes.js":20}],19:[function(e,t){function r(){i.EventEmitter.call(this),this.headers={},this.headers.status=0,this.headers.reason="",this.isConnOpen=!0,this.isStarted=!1,this.isEnded=!1}function n(e){return e.replace(a,function(e,t,r){return r.toUpperCase()})}var i=e("../util");e("../promises.js").promise,e("./helpers.js");var s=e("./content-types.js");t.exports=r,r.prototype=Object.create(i.EventEmitter.prototype),r.prototype.status=function(e,t){return this.headers.status=e,this.headers.reason=t,this};for(var o=200;599>=o;o++)!function(e){r.prototype["s"+e]=function(t){return this.status(e,t)}}(o);r.prototype.header=function(e,t){return e=n(e),"ContentType"==e&&(t=s.lookup(t)),this.headers[e]=t,this},["Allow","ContentType","Link","Location","Pragma"].forEach(function(e){r.prototype[e]=function(t){return this.header(e,t)}}),["json","text","html","csv"].forEach(function(e){r.prototype[e]=function(t){return this.ContentType(e),this.write(t),this}}),r.prototype.event=function(e,t){return this.ContentType("event-stream"),this.write({event:e,data:t}),this},r.prototype.link=function(e){if(this.headers.Link||(this.headers.Link=[]),arguments.length>1)if(Array.isArray(arguments[0]))this.link(i.table.apply(null,arguments));else{var t=arguments[0],r=arguments[1],n=arguments[2];r&&"object"==typeof r&&(n=r,r=!1),n||(n={}),n.href=t,r&&(n.rel=n.rel?n.rel+" "+r:r),this.link(n)}else Array.isArray(e)?this.headers.Link=this.headers.Link.concat(e):this.headers.Link.push(e)};var a=/(^|-)(.)/g;r.prototype.wireUp=function(e,t){if(t){var r=function(e){return function(t){i.nextTick(e.bind(null,t))}};this.once("headers",r(e.emit.bind(e,"headers"))),this.on("data",r(e.emit.bind(e,"data"))),this.once("end",r(e.emit.bind(e,"end"))),this.once("close",r(e.emit.bind(e,"close")))}else this.once("headers",e.emit.bind(e,"headers")),this.on("data",e.emit.bind(e,"data")),this.once("end",e.emit.bind(e,"end")),this.once("close",e.emit.bind(e,"close"))},r.prototype.start=function(){return this.isConnOpen?this.isEnded?this:this.isStarted?this:(this.emit("headers",this.headers),this.isStarted=!0,this):this},r.prototype.write=function(e){return this.isConnOpen?this.isEnded?this:(this.isStarted||this.start(),this.emit("data",e),this):this},r.prototype.end=function(e){return this.isConnOpen?this.isEnded?this:(this.isStarted||this.start(),"undefined"!=typeof e&&this.write(e),this.isEnded=!0,this.emit("end"),this.close(),this):this},r.prototype.close=function(){return this.isConnOpen?(this.isConnOpen=!1,this.emit("close"),this.clearEvents(),this):this}},{"../promises.js":4,"../util":8,"./content-types.js":11,"./helpers.js":12}],20:[function(e,t){function r(e,t){if(e&&Array.isArray(e))for(var n=0,i=e.length;i>n;n++)r(e[n],t);else p[e]=t}function n(e){delete p[e]}function i(e){return p[e]}function s(e,t,r){return t+"-"+r}function o(e){var t={};for(var r in e)if(a.isHeaderKey(r)){var n=r.replace(d,s);t[n]=e[r]}return t}e("../util");var a=e("./helpers.js"),u=e("./content-types.js"),l=e("./http-headers.js"),c=e("./response.js"),f={register:r,unregister:n,get:i},p={};t.exports=f;var h="undefined"!=typeof self&&"undefined"==typeof self.window;f.register(["http","https"],function(e,t){var r=new c;if(r.wireUp(t),h)return r.status(0,"public web requests are not allowed from workers"),r.end(),void 0;var n=a.parseUri(e.headers.url);if(Object.keys(e.headers.params).length){var i=u.serialize("application/x-www-form-urlencoded",e.headers.params);i&&(n.query?n.query+="&"+i:n.query=i,n.relative=n.path+"?"+n.query+(n.anchor?"#"+n.anchor:""))}var s=(n.protocol?n.protocol+"://":"//")+n.authority+n.relative,f=new XMLHttpRequest;f.open(e.headers.method,s,!0),e.isBinary&&(f.responseType="arraybuffer",e.stream&&console.warn("Got HTTP/S request with isBinary=true and stream=true - sorry, not supported, binary responses must be buffered (its a browser thing)",request));var p=o(e.headers);for(var d in p)null!==p[d]&&f.setRequestHeader(d,l.serialize(d,p[d]));var m="";e.on("data",function(t){t&&"object"==typeof t&&e.headers.ContentType&&(t=u.serialize(e.headers.ContentType,t)),"string"==typeof t?m+=t:m=t}),e.on("end",function(){f.send(m)}),e.on("close",function(){f.readyState!==XMLHttpRequest.DONE&&(f.aborted=!0,f.abort()),r.close()});var y=0,v=0,g=!1;f.onreadystatechange=function(){if(f.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&!g){if(g=!0,0!==f.status)if(f.getAllResponseHeaders())f.getAllResponseHeaders().split("\n").forEach(function(e){if(e){var t=e.replace("\r","").split(": ");r.header(t[0],t.slice(1).join(": "))}});else{var n=function(e){var t=f.getResponseHeader(e);t&&r.header(e,t)};n("Accept-Ranges"),n("Age"),n("Allow"),n("Cache-Control"),n("Connection"),n("Content-Encoding"),n("Content-Language"),n("Content-Length"),n("Content-Location"),n("Content-MD5"),n("Content-Disposition"),n("Content-Range"),n("Content-Type"),n("Date"),n("ETag"),n("Expires"),n("Last-Modified"),n("Link"),n("Location"),n("Pragma"),n("Refresh"),n("Retry-After"),n("Server"),n("Set-Cookie"),n("Trailer"),n("Transfer-Encoding"),n("Vary"),n("Via"),n("Warning"),n("WWW-Authenticate")}r.status(f.status,f.statusText),r.start(),e.isBinary||(y=setInterval(function(){var e=f.response.length;if(e>v){var t=f.response.slice(v);v=e,r.write(t)}},50))}if(f.readyState===XMLHttpRequest.DONE)if(y&&clearInterval(y),0===t.status||0!==f.status||f.aborted){if(f.response)if("string"==typeof f.response){var i=f.response.length;i>v&&r.write(f.response.slice(v))}else r.write(f.response);r.end()}else console.debug("XHR looks like it timed out; treating it as a premature close"),r.close()}});var d=/([a-z])([A-Z])/g;f.register("data",function(e,t){for(var r,n=e.headers.url.indexOf(":"),i=e.headers.url.indexOf(","),s=e.headers.url.slice(n+1,i).split(";"),o=s.shift(),a=!1;r=s.shift();)"base64"==r&&(a=!0);var u=e.headers.url.slice(i+1);u||(u=""),u=a?atob(u):decodeURIComponent(u);var l=new c;l.wireUp(t),l.s200().ContentType(o),l.end(u)})},{"../util":8,"./content-types.js":11,"./helpers.js":12,"./http-headers.js":13,"./response.js":19}],21:[function(e,t){function r(e){return e instanceof u||(e=new u(e)),e.headers.method||(e.headers.method="SUBSCRIBE"),e.headers.Accept||e.Accept("events"),e.bufferResponse(!1),new n(e)}function n(e){a.EventEmitter.call(this),this.request=e instanceof u?e:null,this.response=e instanceof l?e:null,this.lastEventId=-1,this.isConnOpen=!0,this.request?(this.thenConnect(this.request),this.request.isStarted||this.request.end()):this.response&&this.connect(this.response)}function i(e){this.emit("message",e),this.emit("error",e)}function s(e){e=c.deserialize("text/event-stream",e);var t=parseInt(e.id,10);"undefined"!=typeof t&&t>this.lastEventId&&(this.lastEventId=t),this.emit("message",e),this.emit(e.event,e)}function o(){this.streams=[]}var a=e("../util"),u=e("./request.js"),l=e("./response.js"),c=e("./content-types.js");n.prototype=Object.create(a.EventEmitter.prototype),n.prototype.getUrl=function(){return this.request?this.request.headers.url:null},n.prototype.thenConnect=function(e){var t=this;return e.then(this.connect.bind(this),function(e){throw t.response=e,i.call(t,{event:"error",data:e}),t.close(),response})},n.prototype.connect=function(e){var t,r=this,n="";return r.response=e,r.isConnOpen=!0,this.memoEventsTillNextTick(),e.on("data",function(i){if("string"==typeof i){for(i=n+i;-1!==(t=i.indexOf("\r\n\r\n"));){var o=i.slice(0,t);s.call(r,o),i=i.slice(t+4)}n=i}else i&&"object"==typeof i&&(Array.isArray(i)?i.forEach(s.bind(r)):s.call(r,i));e._buffer=""}),e.on("end",function(){r.close()}),e.on("close",function(){r.isConnOpen&&r.reconnect()}),e},n.prototype.reconnect=function(){if(this.isConnOpen&&(this.isConnOpen=!1,this.request&&this.request.close()),!a.isAppClosing){if(!this.request)return i.call(this2,{event:"error",data:"Unable to reconnect - no request supplied"}),void 0;this.request=new u(this.request.headers),this.lastEventId&&this.request.header("LastEventID",this.lastEventId),this.thenConnect(this.request),this.request.end()}},n.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.request&&this.request.close(),this.emit("close"))},o.prototype.addStream=function(e){e.broadcastStreamId=this.streams.length,this.streams.push(e);var t=this;return e.on("close",function(){t.endStream(e)}),e.broadcastStreamId},o.prototype.endStream=function(e){"number"==typeof e&&(e=this.streams[e]),delete this.streams[e.broadcastStreamId],e.end()},o.prototype.endAllStreams=function(){this.streams.forEach(function(e){e.end()}),this.streams.length=0},o.prototype.emit=function(e,t,r){r||(r={}),r.exclude&&(Array.isArray(r.exclude)||(r.exclude=[r.exclude]),r.exclude=r.exclude.map(function(e){return e instanceof l?e.broadcastStreamId:e},this)),this.streams.forEach(function(n,i){r.exclude&&-1!==r.exclude.indexOf(i)||this.emitTo(n,e,t)},this)},o.prototype.emitTo=function(e,t,r){"number"==typeof e&&(e=this.streams[e]),e.write({event:t,data:r}),e.body=""},t.exports={subscribe:r,EventStream:n,EventHost:o}},{"../util":8,"./content-types.js":11,"./request.js":18,"./response.js":19}],22:[function(e,t){!function(e){"use strict";function t(e){var r;if(null===e||void 0===e)return!1;if(n.isArray(e))return e.length>0;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!0;for(r in e)if(e.hasOwnProperty(r)&&t(e[r]))return!0;return!1}var r=function(){function e(e){this.options=e}return e.prototype.toString=function(){return JSON&&JSON.stringify?JSON.stringify(this.options):this.options},e}(),n=function(){function e(e){return"[object Array]"===Object.prototype.toString.apply(e)}function t(e){return"[object String]"===Object.prototype.toString.apply(e)}function r(e){return"[object Number]"===Object.prototype.toString.apply(e)}function n(e){return"[object Boolean]"===Object.prototype.toString.apply(e)}function i(e,t){var r,n="",i=!0;for(r=0;r<e.length;r+=1)i?i=!1:n+=t,n+=e[r];return n}function s(e,t){for(var r=[],n=0;n<e.length;n+=1)r.push(t(e[n]));return r}function o(e,t){for(var r=[],n=0;n<e.length;n+=1)t(e[n])&&r.push(e[n]);return r}function a(e){if("object"!=typeof e||null===e)return e;Object.freeze(e);var t,r;for(r in e)e.hasOwnProperty(r)&&(t=e[r],"object"==typeof t&&u(t));return e}function u(e){return"function"==typeof Object.freeze?a(e):e}return{isArray:e,isString:t,isNumber:r,isBoolean:n,join:i,map:s,filter:o,deepFreeze:u}}(),i=function(){function e(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e}function t(e){return e>="0"&&"9">=e}function r(e){return t(e)||e>="a"&&"f">=e||e>="A"&&"F">=e}return{isAlpha:e,isDigit:t,isHexDigit:r}}(),s=function(){function e(e){return e.length>1?e:"0"+e}function t(t){var r,n,i="",s=a.encode(t);for(n=0;n<s.length;n+=1)r=s.charCodeAt(n),i+="%"+e(r.toString(16).toUpperCase());return i}function r(e,t){return"%"===e.charAt(t)&&i.isHexDigit(e.charAt(t+1))&&i.isHexDigit(e.charAt(t+2))}function n(e,t){return parseInt(e.substr(t,2),16)}function s(e){if(!r(e,0))return!1;var t=n(e,1),i=a.numBytes(t);if(0===i)return!1;for(var s=1;i>s;s+=1)if(!r(e,3*s)||!a.isValidFollowingCharCode(n(e,3*s+1)))return!1;return!0}function o(e,t){var i=e.charAt(t);if(!r(e,t))return i;var s=n(e,t+1),o=a.numBytes(s);if(0===o)return i;for(var u=1;o>u;u+=1)if(!r(e,t+3*u)||!a.isValidFollowingCharCode(n(e,t+3*u+1)))return i;return e.substr(t,3*o)}var a={encode:function(e){return unescape(encodeURIComponent(e))},numBytes:function(e){return 127>=e?1:e>=194&&223>=e?2:e>=224&&239>=e?3:e>=240&&244>=e?4:0},isValidFollowingCharCode:function(e){return e>=128&&191>=e}};return{encodeCharacter:t,isPctEncoded:s,pctCharAt:o}}(),o=function(){function e(e){return i.isAlpha(e)||i.isDigit(e)||"_"===e||s.isPctEncoded(e)}function t(e){return i.isAlpha(e)||i.isDigit(e)||"-"===e||"."===e||"_"===e||"~"===e}function r(e){return":"===e||"/"===e||"?"===e||"#"===e||"["===e||"]"===e||"@"===e||"!"===e||"$"===e||"&"===e||"("===e||")"===e||"*"===e||"+"===e||","===e||";"===e||"="===e||"'"===e}return{isVarchar:e,isUnreserved:t,isReserved:r}}(),a=function(){function e(e,t){var r,n="",i="";for(("number"==typeof e||"boolean"==typeof e)&&(e=e.toString()),r=0;r<e.length;r+=i.length)i=e.charAt(r),n+=o.isUnreserved(i)||t&&o.isReserved(i)?i:s.encodeCharacter(i);return n}function t(t){return e(t,!0)}function r(e,t){var r=s.pctCharAt(e,t);return r.length>1?r:o.isReserved(r)||o.isUnreserved(r)?r:s.encodeCharacter(r)}function n(e){var t,r="",n="";for(t=0;t<e.length;t+=n.length)n=s.pctCharAt(e,t),r+=n.length>1?n:o.isReserved(n)||o.isUnreserved(n)?n:s.encodeCharacter(n);return r}return{encode:e,encodePassReserved:t,encodeLiteral:n,encodeLiteralCharacter:r}}(),u=function(){function e(e){t[e]={symbol:e,separator:"?"===e?"&":""===e||"+"===e||"#"===e?",":e,named:";"===e||"&"===e||"?"===e,ifEmpty:"&"===e||"?"===e?"=":"",first:"+"===e?"":e,encode:"+"===e||"#"===e?a.encodePassReserved:a.encode,toString:function(){return this.symbol}}}var t={};return e(""),e("+"),e("#"),e("."),e("/"),e(";"),e("?"),e("&"),{valueOf:function(e){return t[e]?t[e]:"=,!@|".indexOf(e)>=0?null:t[""]}}}(),l=function(){function e(e){this.literal=a.encodeLiteral(e)}return e.prototype.expand=function(){return this.literal},e.prototype.toString=e.prototype.expand,e}(),c=function(){function e(e){function t(){var t=e.substring(h,l);if(0===t.length)throw new r({expressionText:e,message:"a varname must be specified",position:l});p={varname:t,exploded:!1,maxLength:null},h=null}function n(){if(d===l)throw new r({expressionText:e,message:"after a ':' you have to specify the length",position:l});p.maxLength=parseInt(e.substring(d,l),10),d=null}var a,l,c=[],p=null,h=null,d=null,m="";for(a=function(t){var n=u.valueOf(t);if(null===n)throw new r({expressionText:e,message:"illegal use of reserved operator",position:l,operator:t});return n}(e.charAt(0)),l=a.symbol.length,h=l;l<e.length;l+=m.length){if(m=s.pctCharAt(e,l),null!==h){if("."===m){if(h===l)throw new r({expressionText:e,message:"a varname MUST NOT start with a dot",position:l});continue}if(o.isVarchar(m))continue;t()}if(null!==d){if(l===d&&"0"===m)throw new r({expressionText:e,message:"A :prefix must not start with digit 0",position:l});if(i.isDigit(m)){if(l-d>=4)throw new r({expressionText:e,message:"A :prefix must have max 4 digits",position:l});continue}n()}if(":"!==m)if("*"!==m){if(","!==m)throw new r({expressionText:e,message:"illegal character",character:m,position:l});c.push(p),p=null,h=l+1}else{if(null===p)throw new r({expressionText:e,message:"exploded without varspec",position:l});if(p.exploded)throw new r({expressionText:e,message:"exploded twice",position:l});if(p.maxLength)throw new r({expressionText:e,message:"an explode (*) MUST NOT follow to a prefix",position:l});p.exploded=!0}else{if(null!==p.maxLength)throw new r({expressionText:e,message:"only one :maxLength is allowed per varspec",position:l});if(p.exploded)throw new r({expressionText:e,message:"an exploeded varspec MUST NOT be varspeced",position:l});d=l+1}}return null!==h&&t(),null!==d&&n(),c.push(p),new f(e,a,c)}function t(t){var n,i,s=[],o=null,a=0;for(n=0;n<t.length;n+=1)if(i=t.charAt(n),null===a){if(null===o)throw new Error("reached unreachable code");if("{"===i)throw new r({templateText:t,message:"brace already opened",position:n});if("}"===i){if(o+1===n)throw new r({templateText:t,message:"empty braces",position:o});try{s.push(e(t.substring(o+1,n)))}catch(u){if(u.prototype===r.prototype)throw new r({templateText:t,message:u.options.message,position:o+u.options.position,details:u.options});throw u}o=null,a=n+1}}else{if("}"===i)throw new r({templateText:t,message:"unopened brace closed",position:n});"{"===i&&(n>a&&s.push(new l(t.substring(a,n))),a=null,o=n)}if(null!==o)throw new r({templateText:t,message:"unclosed brace",position:o});return a<t.length&&s.push(new l(t.substr(a))),new p(t,s)}return t}(),f=function(){function e(e){return JSON&&JSON.stringify?JSON.stringify(e):e}function r(e){if(!t(e))return!0;if(n.isString(e))return""===e;if(n.isNumber(e)||n.isBoolean(e))return!1;if(n.isArray(e))return 0===e.length;for(var r in e)if(e.hasOwnProperty(r))return!1;return!0}function i(e){var t,r=[];for(t in e)e.hasOwnProperty(t)&&r.push({name:t,value:e[t]});return r}function s(e,t,r){this.templateText=e,this.operator=t,this.varspecs=r}function o(e,t,r){var n="";if(r=r.toString(),t.named){if(n+=a.encodeLiteral(e.varname),""===r)return n+=t.ifEmpty;n+="="}return null!==e.maxLength&&(r=r.substr(0,e.maxLength)),n+=t.encode(r)}function u(e){return t(e.value)}function l(e,s,o){var l=[],c="";if(s.named){if(c+=a.encodeLiteral(e.varname),r(o))return c+=s.ifEmpty;c+="="}return n.isArray(o)?(l=o,l=n.filter(l,t),l=n.map(l,s.encode),c+=n.join(l,",")):(l=i(o),l=n.filter(l,u),l=n.map(l,function(e){return s.encode(e.name)+","+s.encode(e.value)}),c+=n.join(l,",")),c}function c(e,s,o){var l=n.isArray(o),c=[];return l?(c=o,c=n.filter(c,t),c=n.map(c,function(t){var n=a.encodeLiteral(e.varname);return n+=r(t)?s.ifEmpty:"="+s.encode(t)})):(c=i(o),c=n.filter(c,u),c=n.map(c,function(e){var t=a.encodeLiteral(e.name);return t+=r(e.value)?s.ifEmpty:"="+s.encode(e.value)})),n.join(c,s.separator)}function f(e,r){var s=[],o="";return n.isArray(r)?(s=r,s=n.filter(s,t),s=n.map(s,e.encode),o+=n.join(s,e.separator)):(s=i(r),s=n.filter(s,function(e){return t(e.value)}),s=n.map(s,function(t){return e.encode(t.name)+"="+e.encode(t.value)}),o+=n.join(s,e.separator)),o}return s.prototype.toString=function(){return this.templateText},s.prototype.expand=function(i){var s,a,u,p,h=[],d=!1,m=this.operator;for(s=0;s<this.varspecs.length;s+=1)if(a=this.varspecs[s],u=i[a.varname],null!==u&&void 0!==u)if(a.exploded&&(d=!0),p=n.isArray(u),"string"==typeof u||"number"==typeof u||"boolean"==typeof u)h.push(o(a,m,u));else{if(a.maxLength&&t(u))throw new Error("Prefix modifiers are not applicable to variables that have composite values. You tried to expand "+this+" with "+e(u));a.exploded?t(u)&&(m.named?h.push(c(a,m,u)):h.push(f(m,u))):(m.named||!r(u))&&h.push(l(a,m,u))}return 0===h.length?"":m.first+n.join(h,m.separator)},s}(),p=function(){function e(e,t){this.templateText=e,this.expressions=t,n.deepFreeze(this)}return e.prototype.toString=function(){return this.templateText},e.prototype.expand=function(e){var t,r="";for(t=0;t<this.expressions.length;t+=1)r+=this.expressions[t].expand(e);return r},e.parse=c,e.UriTemplateError=r,e}();e(p)}(function(e){t.exports=e})},{}],23:[function(e,t){function r(e){if("string"==typeof e&&(e=a.parseUri(e)),!e.authority||"."==e.authority){var t=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")),r=window.location.origin+t,i=a.joinRelPath(r,e.source);e=local.parseUri(i)}var s=e.authority+e.path,o=c[s];if(o)return o.onRequest.bind(o);if(".js"==e.path.slice(-3)){n(e);var o=c[s];return o.onRequest.bind(o)}return function(t,r){r.status(0,"request to "+e.source+" expects "+e.path+" to be a .js file"),r.end()}}function n(e){var t=i(e);return t.setTemporary(),t}function i(e){if("string"==typeof e&&(e=a.parseUri(e)),!e.authority||"."==e.authority){var t=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")),r=window.location.protocol+"//"+window.location.hostname+t,n=a.joinRelPath(r,e.source);e=local.parseUri(n)}if(Object.keys(l).length>=local.maxActiveWorkers){var i=null;for(var s in l)if(l[s].isTemp&&!c[s].isInTransaction()){i=s;break}console.log("Closing temporary worker",i),l[i].terminate(),delete l[i],delete c[i]}var f=e.authority+e.path,p=new o(f);return l[f]=p,c[f]=new u(p),p.load(e),p}function s(e){var t=local.parseUri(e);if(!t.authority||"."==t.authority||-1===t.authority.indexOf(".")){var r=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")),n=window.location.protocol+"//"+window.location.hostname+r,e=a.joinRelPath(n,t.source);t=local.parseUri(e)}var i=t.authority+t.path;return i in l?(l[i].terminate(),delete l[i],delete c[i],!0):!1}function o(e){this.isReady=!1,this.isTemp=!1,this.id=e,this.worker=null,this.script_blob=null,this.script_objurl=null,this.source_url=null}var a=e("./helpers.js");e("../promises.js").promise;var u=e("./bridge.js");t.exports={getWorker:r,spawnWorker:i,spawnTempWorker:n,closeWorker:s};var l={},c={},f={};o.prototype.setTemporary=function(e){"undefined"==typeof e&&(e=!0),this.isTemp=e},o.prototype.load=function(t){var r=(t.protocol?t.protocol+"://":"")+t.authority+t.path,n=this,i=r;if(!t.protocol){var s=f[t.authority];s||(s=f[t.authority]="https://"),i=s+r}GET(i).Accept("application/javascript, text/javascript, text/plain, */*").fail(function(e){if(!t.protocol&&0===e.status)return i="http://"+r,f[t.authority]="http://",GET(i);throw e}).then(function(r){n.source_url=i;var s=e("../config.js").workerBootstrapScript,o=local.parseUri("data"!=t.protocol?i:window.location.protocol+"//"+window.location.hostname),a=o.protocol+"://"+o.authority;s=s.replace(/<HOST>/g,a),s=s.replace(/<HOST_DIR_PATH>/g,(o.directory||"").slice(0,-1)),s=s.replace(/<HOST_DIR_URL>/g,a+(o.directory||"").slice(0,-1)),n.script_blob=new Blob([s+"(function(){"+r.body+"})();"],{type:"text/javascript"}),n.script_objurl=window.URL.createObjectURL(n.script_blob),n.worker=new Worker(n.script_objurl),n.setup()
}).fail(function(){n.terminate(404,"Worker Not Found")})},o.prototype.setup=function(){var e=this;this.worker.addEventListener("message",function(t){var r=t.data;if(!r)return console.error("Invalid message from worker: Payload missing",this,t);switch(r.op){case"ready":e.isReady=!0,c[e.id].flushBufferedMessages();break;case"log":e.onWorkerLog(r.body);break;case"terminate":e.terminate();break;default:c[e.id].onMessage(r)}})},o.prototype.postMessage=function(e){this.worker&&this.worker.postMessage(e)},o.prototype.terminate=function(e,t){c[this.id]&&c[this.id].terminate(e,t),this.worker&&this.worker.terminate(),this.script_objurl&&window.URL.revokeObjectURL(this.script_objurl),delete c[this.id],this.worker=null,this.script_blob=null,this.script_objurl=null,this.isReady=!1},o.prototype.onWorkerLog=function(e){if(e){if(!Array.isArray(e))return console.error('Received invalid "log" operation: Payload must be an array',e);var t=e.shift(),r=["["+this.source_url+"]"].concat(e);switch(t){case"error":console.error.apply(console,r);break;case"warn":console.warn.apply(console,r);break;default:console.log.apply(console,r)}}}},{"../config.js":1,"../promises.js":4,"./bridge.js":9,"./helpers.js":12}],24:[function(e){"undefined"!=typeof self&&"undefined"==typeof self.window&&function(){function t(e,t){try{self.postMessage({op:"log",body:[e].concat(t)})}catch(n){self.postMessage({op:"log",body:[e].concat(t.map(r))})}}function r(e){return Array.isArray(e)?e.map(r):e&&"object"==typeof e?JSON.stringify(e):e}function n(e,t){var r=255&e.charCodeAt(t);return r}if(self.console={log:function(){var e=Array.prototype.slice.call(arguments);t("log",e)},dir:function(){var e=Array.prototype.slice.call(arguments);t("dir",e)},debug:function(){var e=Array.prototype.slice.call(arguments);t("debug",e)},warn:function(){var e=Array.prototype.slice.call(arguments);t("warn",e)},error:function(){var e=Array.prototype.slice.call(arguments);t("error",e)}},"undefined"==typeof btoa){var i="=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";self.btoa=function(e){var t,r,o=i,a=s,u=[];e=""+e;var l=e.length-e.length%3;if(0===e.length)return e;for(t=0;l>t;t+=3)r=n(e,t)<<16|n(e,t+1)<<8|n(e,t+2),u.push(a.charAt(r>>18)),u.push(a.charAt(63&r>>12)),u.push(a.charAt(63&r>>6)),u.push(a.charAt(63&r));switch(e.length-l){case 1:r=n(e,t)<<16,u.push(a.charAt(r>>18)+a.charAt(63&r>>12)+o+o);break;case 2:r=n(e,t)<<16|n(e,t+1)<<8,u.push(a.charAt(r>>18)+a.charAt(63&r>>12)+a.charAt(63&r>>6)+o)}return u.join("")}}var o=e("../web/bridge.js");self.pageBridge=new o(self),self.addEventListener("message",function(e){var t=e.data;return t?(pageBridge.onMessage(t),void 0):console.error("Invalid message from page: Payload missing",e)}),self.postMessage({op:"ready"})}()},{"../web/bridge.js":9}]},{},[3]);